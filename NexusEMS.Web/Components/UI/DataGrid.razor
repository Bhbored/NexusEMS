@typeparam TItem

<div class="card datagrid-modern border-0 shadow-sm">
    <div class="card-header datagrid-header p-4 border-bottom">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h2 class="h5 fw-semibold mb-0">@Title</h2>
            <div class="d-flex flex-column flex-sm-row gap-3 w-100 w-md-auto">
                <div class="position-relative datagrid-search-wrapper">
                    <i class="bi bi-search position-absolute datagrid-search-icon"></i>
                    <input type="text" 
                           class="form-control datagrid-search-input" 
                           placeholder="Search..." 
                           @bind="SearchTerm" 
                           @bind:event="oninput" />
                </div>
                @if (OnAddClick.HasDelegate)
                {
                    <button class="btn btn-primary datagrid-add-btn" @onclick="OnAddClick">
                        <i class="bi bi-plus-lg me-1"></i> Add New
                    </button>
                }
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table datagrid-table mb-0">
                <thead class="datagrid-thead">
                    <tr>
                        @HeaderContent
                    </tr>
                </thead>
                <tbody class="datagrid-tbody">
                    @if (Items == null)
                    {
                        <tr>
                            <td colspan="100" class="text-center py-5 text-muted">
                                <div class="spinner-border text-primary spinner-border-sm me-2" role="status"></div>
                                Loading data...
                            </td>
                        </tr>
                    }
                    else if (!FilteredItems.Any())
                    {
                        <tr>
                            <td colspan="100" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                                No records found.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in FilteredItems)
                        {
                            <tr class="datagrid-row" @onclick="() => OnRowClick.InvokeAsync(item)" style="@(OnRowClick.HasDelegate ? "cursor: pointer;" : "")">
                                @RowTemplate(item)
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
    @if (TotalPages > 1)
    {
        <div class="card-footer datagrid-footer p-4 border-top">
            <nav aria-label="Table navigation" class="d-flex justify-content-end">
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm datagrid-pagination-btn" 
                            @onclick="() => ChangePage(CurrentPage - 1)" 
                            disabled="@(CurrentPage == 1)">
                        Previous
                    </button>
                    @for (int i = 1; i <= TotalPages; i++)
                    {
                        var pageIndex = i;
                        <button class="btn btn-sm datagrid-pagination-btn @(CurrentPage == pageIndex ? "datagrid-pagination-active" : "")" 
                                @onclick="() => ChangePage(pageIndex)">
                            @pageIndex
                        </button>
                    }
                    <button class="btn btn-sm datagrid-pagination-btn" 
                            @onclick="() => ChangePage(CurrentPage + 1)" 
                            disabled="@(CurrentPage == TotalPages)">
                        Next
                    </button>
                </div>
            </nav>
        </div>
    }
</div>

@code {
    [Parameter] public string Title { get; set; } = "Data Grid";
    [Parameter] public IEnumerable<TItem> Items { get; set; }
    [Parameter] public RenderFragment HeaderContent { get; set; }
    [Parameter] public RenderFragment<TItem> RowTemplate { get; set; }
    [Parameter] public EventCallback<TItem> OnRowClick { get; set; }
    [Parameter] public EventCallback OnAddClick { get; set; }
    [Parameter] public Func<TItem, string, bool> FilterStrategy { get; set; }

    private string _searchTerm = "";
    public string SearchTerm
    {
        get => _searchTerm;
        set
        {
            _searchTerm = value;
            CurrentPage = 1;
        }
    }

    private int CurrentPage { get; set; } = 1;
    private int PageSize { get; set; } = 10;

    private IEnumerable<TItem> FilteredItems
    {
        get
        {
            if (Items == null) return Enumerable.Empty<TItem>();
            
            var query = Items;
            if (!string.IsNullOrWhiteSpace(SearchTerm) && FilterStrategy != null)
            {
                query = query.Where(item => FilterStrategy(item, SearchTerm));
            }
            
            return query.Skip((CurrentPage - 1) * PageSize).Take(PageSize);
        }
    }

    private int TotalPages
    {
        get
        {
            if (Items == null) return 0;
            var query = Items;
            if (!string.IsNullOrWhiteSpace(SearchTerm) && FilterStrategy != null)
            {
                query = query.Where(item => FilterStrategy(item, SearchTerm));
            }
            return (int)Math.Ceiling((double)query.Count() / PageSize);
        }
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
    }
}
