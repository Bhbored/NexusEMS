@page "/chief/dashboard"
@using NexusEMS.Shared.Models
@using NexusEMS.Web.Components.Employee
@using NexusEMS.Web.Services
@using NexusEMS.Web.Tests
@inject AppStateService AppState

<div class="row g-3 mb-4">
    <!-- Stats Cards -->
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-start border-primary border-4">
            <div class="text-muted small text-uppercase fw-bold">My Team</div>
            <div class="fs-2 fw-bold text-primary">@MyTeamCount</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 shadow-sm border-start border-success border-4">
             <div class="text-muted small text-uppercase fw-bold">Active Members</div>
             <div class="fs-2 fw-bold text-success">@ActiveTeamMembers</div>
        </div>
    </div>
     <div class="col-md-4">
        <div class="card p-3 shadow-sm border-start border-info border-4">
             <div class="text-muted small text-uppercase fw-bold">Budget Utilization</div>
             <div class="fs-2 fw-bold text-info">@BudgetUtilization%</div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <h5 class="mb-3">Department Performance</h5>
        <div class="card shadow-sm h-100">
             <div class="card-body d-flex align-items-center justify-content-center text-muted" style="min-height: 300px;">
                 <!-- Placeholder for a Chart -->
                 <div class="text-center">
                     <i class="bi bi-bar-chart-fill fs-1 mb-2"></i>
                     <p>Performance Metrics Chart</p>
                 </div>
             </div>
        </div>
    </div>
    <div class="col-lg-4">
        <h5 class="mb-3">Recent Team Activity</h5>
         <div class="list-group shadow-sm">
             @foreach (var activity in TeamActivities)
            {
                <div class="list-group-item py-3">
                    <div class="d-flex w-100 justify-content-between">
                        <strong class="mb-1">@activity.Title</strong>
                        <small class="text-muted">@activity.TimeAgo</small>
                    </div>
                    <small class="text-muted">@activity.Description</small>
                </div>
            }
         </div>
    </div>
</div>

@code {
    private List<Employee> teamMembers = new();
    private Department? myDepartment;
    private List<Activity> TeamActivities = new();
    
    private int MyTeamCount => teamMembers.Count;
    private int ActiveTeamMembers => teamMembers.Count(e => e.IsActive);
    private int BudgetUtilization => myDepartment?.Budget > 0 ? (int)((teamMembers.Sum(e => e.Salary ?? 0) / (decimal)myDepartment.Budget) * 100) : 0;

    private class Activity { public string Title { get; set; } = string.Empty; public string Description { get; set; } = string.Empty; public string TimeAgo { get; set; } = string.Empty; }

    protected override void OnInitialized()
    {
        var employees = MockEmployees.GetEmployees();
        var departments = MockDepartments.GetDepartments();
        
        if (AppState.CurrentUser?.DepartmentId.HasValue == true)
        {
            myDepartment = departments.FirstOrDefault(d => d.Id == AppState.CurrentUser.DepartmentId);
            teamMembers = employees.Where(e => e.DepartmentId == AppState.CurrentUser.DepartmentId).ToList();
        }
    }
}
