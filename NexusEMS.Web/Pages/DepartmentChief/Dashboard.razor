@page "/chief/dashboard"
@using NexusEMS.Shared.Enums
@using NexusEMS.Shared.Models
@using NexusEMS.Web.Components.Employee
@using NexusEMS.Web.Services
@inject AuthService AuthService
@inject TestDataService TestData

<div class="row g-4 mb-4">
    <!-- Stats Cards -->
    <div class="col-md-6 col-lg-4">
        <div class="card dashboard-stat-card border-0">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <p class="text-uppercase small fw-semibold mb-1 text-muted">My Team</p>
                        <h3 class="display-6 fw-bold mb-0 dashboard-stat-cyan">@MyTeamCount</h3>
                    </div>
                    <div class="dashboard-icon-bg dashboard-icon-cyan">
                        <i class="bi bi-people fs-4"></i>
                    </div>
                </div>
                <div class="d-flex align-items-center small text-muted">
                    <span>Total team members</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-4">
        <div class="card dashboard-stat-card border-0">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <p class="text-uppercase small fw-semibold mb-1 text-muted">Active Members</p>
                        <h3 class="display-6 fw-bold mb-0 text-success">@ActiveTeamMembers</h3>
                    </div>
                    <div class="dashboard-icon-bg dashboard-icon-green">
                        <i class="bi bi-check-circle fs-4"></i>
                    </div>
                </div>
                <div class="d-flex align-items-center small text-muted">
                    <span>@(MyTeamCount > 0 ? (int)((ActiveTeamMembers / (double)MyTeamCount) * 100) : 0)% active rate</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-4">
        <div class="card dashboard-stat-card border-0">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <p class="text-uppercase small fw-semibold mb-1 text-muted">Budget Utilization</p>
                        <h3 class="display-6 fw-bold mb-0 dashboard-stat-blue">@BudgetUtilization%</h3>
                    </div>
                    <div class="dashboard-icon-bg dashboard-icon-blue">
                        <i class="bi bi-pie-chart fs-4"></i>
                    </div>
                </div>
                <div class="d-flex align-items-center small text-muted">
                    <span>@(myDepartment?.Budget.HasValue == true ? $"${teamMembers.Sum(e => e.CurrentNetSalary):N0} / ${myDepartment.Budget:N0}" : "No budget set")</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Department Performance -->
    <div class="col-lg-8">
        <div class="card border-0 h-100">
            <div class="card-body p-4 d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h5 fw-semibold mb-0">Department Performance</h2>
                </div>
                <div class="flex-grow-1 d-flex flex-column align-items-center justify-content-center p-5 dashboard-empty-state">
                    <div class="dashboard-empty-icon mb-3">
                        <i class="bi bi-bar-chart-fill fs-1 text-muted"></i>
                    </div>
                    <h3 class="h6 fw-medium mb-1">Performance Metrics Chart</h3>
                    <p class="small text-muted mb-0">Chart visualization will appear here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Team Activity -->
    <div class="col-lg-4">
        <div class="card border-0 h-100">
            <div class="card-body p-4 d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h5 fw-semibold mb-0">Recent Team Activity</h2>
                </div>
                @if (TeamActivities.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var activity in TeamActivities)
                        {
                            <div class="list-group-item d-flex align-items-start py-3">
                                <div class="flex-grow-1">
                                    <div class="fw-bold mb-1">@activity.Title</div>
                                    <small class="text-muted d-block">@activity.Description</small>
                                    <small class="text-muted">@activity.TimeAgo</small>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="flex-grow-1 d-flex flex-column align-items-center justify-content-center p-5 dashboard-empty-state">
                        <div class="dashboard-empty-icon mb-3">
                            <i class="bi bi-clock-history fs-1 text-muted"></i>
                        </div>
                        <h3 class="h6 fw-medium mb-1">No recent activity</h3>
                        <p class="small text-muted mb-0">Team updates will appear here.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<Employee> teamMembers = new();
    private Department? myDepartment;
    private List<Activity> TeamActivities = new();

    private int MyTeamCount => teamMembers.Count;
    private int ActiveTeamMembers => teamMembers.Count(e => e.EmploymentStatus == EmploymentStatus.Active);
    private int BudgetUtilization => myDepartment?.Budget > 0 ? (int)((teamMembers.Sum(e => e.CurrentNetSalary) / (decimal)myDepartment.Budget) * 100) : 0;

    private class Activity { public string Title { get; set; } = string.Empty; public string Description { get; set; } = string.Empty; public string TimeAgo { get; set; } = string.Empty; }

    protected override void OnInitialized()
    {
        var employees = TestData.GetEmployees();
        var departments = TestData.GetDepartments();

        if (AuthService.CurrentUser?.DepartmentId.HasValue == true)
        {
            myDepartment = departments.FirstOrDefault(d => d.Id == AuthService.CurrentUser.DepartmentId);
            teamMembers = employees.Where(e => e.DepartmentId == AuthService.CurrentUser.DepartmentId).ToList();
        }
    }
}
