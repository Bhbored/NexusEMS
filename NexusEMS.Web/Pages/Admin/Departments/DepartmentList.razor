@page "/admin/departments"
@using NexusEMS.Shared.Models
@using NexusEMS.Web.Components.UI
@using NexusEMS.Web.Tests
@inject NavigationManager Navigation

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Department Management</h3>
</div>

<DataGrid TItem="Department" 
          Items="@Departments" 
          Title="All Departments"
          OnAddClick="@(() => Navigation.NavigateTo("/admin/departments/create"))"
          FilterStrategy="@FilterDepartments">
    <HeaderContent>
        <th>Department Name</th>
        <th>Description</th>
        <th>Head of Dept.</th>
        <th>Employees</th>
        <th>Budget</th>
        <th class="text-end">Actions</th>
    </HeaderContent>
    <RowTemplate Context="dept">
        <td class="fw-bold">@dept.Name</td>
        <td>
             <span class="d-inline-block text-truncate" style="max-width: 200px;">
                @dept.Description
            </span>
        </td>
        <td>@dept.HeadOfDepartmentName</td>
        <td>
            <span class="badge bg-secondary">@(dept.Employees?.Count ?? 0)</span>
        </td>
        <td>@(dept.Budget.HasValue ? dept.Budget.Value.ToString("C") : "-")</td>
        <td class="text-end">
            <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditDepartment(dept.Id)" title="Edit">
                <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteDepartment(dept)" title="Delete">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </RowTemplate>
</DataGrid>

<ConfirmationDialog @ref="DeleteConfirmation" 
                    Title="Delete Department" 
                    Message="@($"Are you sure you want to delete {DepartmentToDelete?.Name}?")"
                    OnConfirmation="OnDeleteConfirmed" />

@code {
    private List<Department> Departments = new();
    private ConfirmationDialog DeleteConfirmation;
    private Department DepartmentToDelete;

    protected override void OnInitialized()
    {
        var departments = MockDepartments.GetDepartments();
        var employees = MockEmployees.GetEmployees();
        
        Departments = departments.Select(d =>
        {
            d.Employees = employees.Where(e => e.DepartmentId == d.Id).ToList();
            return d;
        }).ToList();
    }

    private bool FilterDepartments(Department dept, string searchTerm)
    {
        if (string.IsNullOrWhiteSpace(searchTerm)) return true;
        searchTerm = searchTerm.ToLower();
        return dept.Name.ToLower().Contains(searchTerm) ||
               (dept.Description?.ToLower().Contains(searchTerm) ?? false) ||
               (dept.HeadOfDepartmentName?.ToLower().Contains(searchTerm) ?? false);
    }

    private void EditDepartment(int id)
    {
        Navigation.NavigateTo($"/admin/departments/edit/{id}");
    }

    private void DeleteDepartment(Department dept)
    {
        DepartmentToDelete = dept;
        DeleteConfirmation.Show();
    }

    private void OnDeleteConfirmed(bool confirmed)
    {
        if (confirmed && DepartmentToDelete != null)
        {
            Departments.Remove(DepartmentToDelete);
            DepartmentToDelete = null;
            StateHasChanged();
        }
    }
}
