@page "/admin/departments"
@using NexusEMS.Shared.Models
@using NexusEMS.Web.Components.UI
@using NexusEMS.Web.Tests
@inject NavigationManager Navigation

<div class="mb-6">
    <h1 class="h2 fw-bold mb-1">Department Management</h1>
    <p class="text-muted mb-0">Manage your company departments, budgets, and personnel.</p>
</div>

<DataGrid TItem="Department" 
          Items="@Departments" 
          Title="All Departments"
          OnAddClick="@(() => Navigation.NavigateTo("/admin/departments/create"))"
          FilterStrategy="@FilterDepartments">
    <HeaderContent>
        <th>Department Name</th>
        <th>Description</th>
        <th>Head of Dept.</th>
        <th class="text-center">Employees</th>
        <th>Budget</th>
        <th class="text-end">Actions</th>
    </HeaderContent>
    <RowTemplate Context="dept">
        <td>
            <div class="fw-medium">@dept.Name</div>
        </td>
        <td>
            <span class="d-inline-block text-truncate department-description" style="max-width: 200px;" title="@dept.Description">
                @dept.Description
            </span>
        </td>
        <td>
            @if (dept.HeadOfDepartmentId.HasValue && !string.IsNullOrEmpty(dept.HeadOfDepartmentName))
            {
                <div class="d-flex align-items-center gap-2">
                    <div class="department-head-avatar department-head-avatar-indigo">
                        <span class="small fw-bold">@GetInitials(dept.HeadOfDepartmentName)</span>
                    </div>
                    <span class="small">@dept.HeadOfDepartmentName</span>
                </div>
            }
            else
            {
                <div class="small text-muted fst-italic">Unassigned</div>
            }
        </td>
        <td class="text-center">
            <span class="badge department-employee-badge">
                @(GetEmployeeCount(dept.Id))
            </span>
        </td>
        <td class="department-budget">
            @(dept.Budget.HasValue ? dept.Budget.Value.ToString("C") : "-")
        </td>
        <td class="text-end">
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm department-action-btn department-action-edit" 
                        @onclick="() => EditDepartment(dept.Id)" 
                        title="Edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm department-action-btn department-action-delete" 
                        @onclick="() => DeleteDepartment(dept)" 
                        title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </td>
    </RowTemplate>
</DataGrid>

<ConfirmationDialog @ref="DeleteConfirmation" 
                    Title="Delete Department" 
                    Message="@($"Are you sure you want to delete {DepartmentToDelete?.Name}?")"
                    OnConfirmation="OnDeleteConfirmed" />

@code {
    private List<Department> Departments = new();
    private ConfirmationDialog DeleteConfirmation;
    private Department DepartmentToDelete;

    protected override void OnInitialized()
    {
        var departments = MockDepartments.GetDepartments();
        var employees = MockEmployees.GetEmployees();
        
        Departments = departments.Select(d =>
        {
            d.Employees = employees.Where(e => e.DepartmentId == d.Id).ToList();
            return d;
        }).ToList();
    }

    private bool FilterDepartments(Department dept, string searchTerm)
    {
        if (string.IsNullOrWhiteSpace(searchTerm)) return true;
        searchTerm = searchTerm.ToLower();
        return dept.Name.ToLower().Contains(searchTerm) ||
               (dept.Description?.ToLower().Contains(searchTerm) ?? false) ||
               (dept.HeadOfDepartmentName?.ToLower().Contains(searchTerm) ?? false);
    }

    private void EditDepartment(int id)
    {
        Navigation.NavigateTo($"/admin/departments/edit/{id}");
    }

    private void DeleteDepartment(Department dept)
    {
        DepartmentToDelete = dept;
        DeleteConfirmation.Show();
    }

    private void OnDeleteConfirmed(bool confirmed)
    {
        if (confirmed && DepartmentToDelete != null)
        {
            Departments.Remove(DepartmentToDelete);
            DepartmentToDelete = null;
            StateHasChanged();
        }
    }

    private int GetEmployeeCount(int departmentId)
    {
        return Departments.FirstOrDefault(d => d.Id == departmentId)?.Employees?.Count ?? 0;
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "";
        var parts = name.Split(' ');
        if (parts.Length >= 2)
        {
            return $"{parts[0].FirstOrDefault()}{parts[1].FirstOrDefault()}";
        }
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }
}
