@page "/admin/employees"
@using NexusEMS.Shared.Models
@using NexusEMS.Web.Components.UI
@inject TestDataService TestData
@inject NavigationManager Navigation

<div class="mb-6">
    <h1 class="h2 fw-bold mb-1">Employee Management</h1>
    <p class="text-muted mb-0">Manage your team members and their account permissions here.</p>
</div>

<DataGrid TItem="Employee" 
          Items="@Employees" 
          Title="All Employees"
          OnAddClick="@(() => Navigation.NavigateTo("/admin/employees/create"))"
          FilterStrategy="@FilterEmployees">
    <HeaderContent>
        <th>Code</th>
        <th>Name</th>
        <th>Department</th>
        <th>Position</th>
        <th>Status</th>
        <th class="text-end">Actions</th>
    </HeaderContent>
    <RowTemplate Context="employee">
        <td class="employee-code">@employee.EmployeeCode</td>
        <td>
            <div class="d-flex align-items-center">
                <div class="employee-avatar-small employee-avatar-@GetAvatarColor(employee.Id) me-3">
                    <span class="fw-bold">@GetInitials(employee.FirstName, employee.LastName)</span>
                </div>
                <div>
                    <div class="fw-medium">@employee.FirstName @employee.LastName</div>
                    <div class="small text-muted">@employee.Email</div>
                </div>
            </div>
        </td>
        <td>@employee.Department?.Name</td>
        <td>@employee.Position</td>
        <td>
            <span class="badge employee-status-badge-modern">
                @(employee.IsActive ? "Active" : "Inactive")
            </span>
        </td>
        <td class="text-end">
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm employee-action-btn employee-action-edit" 
                        @onclick="() => EditEmployee(employee.Id)" 
                        title="Edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm employee-action-btn employee-action-delete" 
                        @onclick="() => DeleteEmployee(employee)" 
                        title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </td>
    </RowTemplate>
</DataGrid>

<ConfirmationDialog @ref="DeleteConfirmation" 
                    Title="Delete Employee" 
                    Message="@($"Are you sure you want to delete {EmployeeToDelete?.FirstName} {EmployeeToDelete?.LastName}?")"
                    OnConfirmation="OnDeleteConfirmed" />

@code {
    private List<Employee> Employees = new();
    private ConfirmationDialog DeleteConfirmation;
    private Employee EmployeeToDelete;

    protected override void OnInitialized()
    {
        var employees = TestData.GetEmployees();
        var departments = TestData.GetDepartments();

        Employees = employees.Select(e =>
        {
            e.Department = departments.FirstOrDefault(d => d.Id == e.DepartmentId);
            return e;
        }).ToList();
    }

    private bool FilterEmployees(Employee emp, string searchTerm)
    {
        if (string.IsNullOrWhiteSpace(searchTerm)) return true;
        searchTerm = searchTerm.ToLower();
        return emp.FirstName.ToLower().Contains(searchTerm) ||
               emp.LastName.ToLower().Contains(searchTerm) ||
               emp.Email.ToLower().Contains(searchTerm) ||
               (emp.Department?.Name?.ToLower().Contains(searchTerm) ?? false) ||
               emp.Position!.Title.ToLower().Contains(searchTerm);
    }

    private void EditEmployee(Guid id)
    {
        Navigation.NavigateTo($"/admin/employees/edit/{id}");
    }

    private void DeleteEmployee(Employee emp)
    {
        EmployeeToDelete = emp;
        DeleteConfirmation.Show();
    }

    private void OnDeleteConfirmed(bool confirmed)
    {
        if (confirmed && EmployeeToDelete != null)
        {
            Employees.Remove(EmployeeToDelete);
            EmployeeToDelete = null;
            StateHasChanged();
        }
    }

    private string GetInitials(string? first, string? last)
    {
        return $"{(first?.FirstOrDefault())}{(last?.FirstOrDefault())}";
    }

    private string GetAvatarColor(Guid employeeId)
    {
        var colors = new[] { "indigo", "blue", "orange", "pink" };
        var index = 1;
        return colors[index];
    }
}
